{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<link rel="stylesheet" href="{{ url_for('static', filename='ng.css') }}">

<h1>üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏</h1>

<div style="text-align: center; margin: 20px 0;">
    {% if user_logged_in %}
        <div style="color: #FFD700; margin-bottom: 10px; font-size: 18px;">
            üëã –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{{ user_name }}</strong>
        </div>
        <div style="margin-bottom: 15px;">
            <button onclick="resetAll()" style="background: #f44336; padding: 12px 25px; font-size: 16px;">
                üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ (–Ω–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏)
            </button>
        </div>
        <div style="color: #32CD32; font-size: 14px;">
            üîì –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏, –≤–∫–ª—é—á–∞—è –æ—Å–æ–±—ã–µ!
        </div>
    {% else %}
        <div style="color: #FFD700; margin-bottom: 15px; font-size: 16px;">
            üîí –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
        </div>
        <div style="display: inline-block; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
            <a href="/lab8/login" style="color: #FFD700; text-decoration: none; margin: 0 10px; font-weight: bold;">–í–æ–π—Ç–∏</a>
            |
            <a href="/lab8/register" style="color: #32CD32; text-decoration: none; margin: 0 10px; font-weight: bold;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </div>
        <div style="color: #FFD700; margin-top: 10px; font-size: 14px;">
            ‚≠ê –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –æ—Ç–∫—Ä–æ—é—Ç—Å—è –æ—Å–æ–±—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è "–î–µ–¥ –ú–æ—Ä–æ–∑"
        </div>
    {% endif %}
</div>

<div style="display: flex; justify-content: center; gap: 40px; margin: 30px 0;">
    <div style="text-align: center; background: rgba(255,215,0,0.1); padding: 15px 25px; border-radius: 10px; border: 1px solid #FFD700;">
        <div style="font-size: 36px; color: #FFD700; font-weight: bold;" id="count">{{ opened_count }}</div>
        <div style="color: #32CD32;">–û—Ç–∫—Ä—ã—Ç–æ</div>
    </div>
    <div style="text-align: center; background: rgba(50,205,50,0.1); padding: 15px 25px; border-radius: 10px; border: 1px solid #32CD32;">
        <div style="font-size: 36px; color: #FFD700; font-weight: bold;" id="left">{{ 10 - opened_count }}</div>
        <div style="color: #32CD32;">–û—Å—Ç–∞–ª–æ—Å—å</div>
    </div>
    <div style="text-align: center; background: rgba(178,34,34,0.1); padding: 15px 25px; border-radius: 10px; border: 1px solid #b22222;">
        <div style="font-size: 36px; color: #FFD700; font-weight: bold;">3</div>
        <div style="color: #32CD32;">–õ–∏–º–∏—Ç –æ—Ç–∫—Ä—ã—Ç–∏–π</div>
    </div>
</div>

<div style="text-align: center; margin: 20px 0; color: #FFD700; font-size: 14px;">
    –ü–æ–¥–∞—Ä–∫–∏ —Å üîí –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
</div>

<div style="position: relative; height: 400px; margin: 30px 0; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; border: 2px solid #FFD700;">
    {% for box in boxes %}
    <div class="gift-box" 
         data-id="{{ box.id }}"
         data-opened="{{ box.opened }}"
         onclick="openBox({{ box.id }})"
         style="position: absolute; 
                left: {{ box.x }}%; 
                top: {{ box.y }}%; 
                width: 85px; 
                height: 85px; 
                cursor: {{ 'default' if box.opened else 'pointer' }};
                text-align: center;">
        
        <img src="/static/lab9/{{ box.id }}.png" 
             alt="–ü–æ–¥–∞—Ä–æ–∫ {{ box.id }}"
             style="width: 100%; 
                    height: 100%;
                    border-radius: 10px;
                    border: {{ '3px solid #666' if box.opened else '3px solid #FFD700' }};
                    {% if box.opened %}opacity: 0.5; filter: grayscale(100%);{% endif %}">
        
        <div style="margin-top: 5px; 
                    font-size: 14px; 
                    color: {{ '#FFD700' if box.lock and not box.opened else '#32CD32' }};
                    font-weight: bold;
                    text-shadow: 1px 1px 2px black;
                    background: rgba(0,0,0,0.7);
                    padding: 2px 5px;
                    border-radius: 3px;">
            {{ box.id }}{% if box.lock and not box.opened %} üîí{% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div id="result" style="display: none; 
                        position: fixed; 
                        top: 50%; 
                        left: 50%; 
                        transform: translate(-50%, -50%); 
                        background: #0c2c1c; 
                        padding: 30px; 
                        border-radius: 15px; 
                        border: 3px solid #FFD700;
                        box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
                        z-index: 1000;
                        text-align: center;
                        min-width: 400px;">
    <div style="color: #FFD700; font-size: 24px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">
        üéâ –í–∞—à –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –ø–æ–¥–∞—Ä–æ–∫! üéâ
    </div>
    <img id="congrat" src="" 
         style="max-width: 350px; 
                max-height: 250px; 
                border-radius: 10px;
                border: 2px solid #32CD32;
                margin: 10px 0;">
    <div style="margin-top: 20px;">
        <button onclick="closeResult()" style="padding: 10px 30px; font-size: 16px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="overlay" style="display: none; 
                         position: fixed; 
                         top: 0; 
                         left: 0; 
                         width: 100%; 
                         height: 100%; 
                         background: rgba(0,0,0,0.8); 
                         z-index: 999;"></div>

<div id="msg" style="display: none; 
                     position: fixed; 
                     top: 50px; 
                     left: 50%; 
                     transform: translateX(-50%); 
                     padding: 15px 25px; 
                     border-radius: 8px; 
                     background: #b22222; 
                     color: #FFD700;
                     font-weight: bold;
                     border: 2px solid #FFD700;
                     z-index: 1001;
                     text-align: center;"></div>

<script>
function openBox(id) {
    const box = document.querySelector(`.gift-box[data-id="${id}"]`);
    const opened = box.dataset.opened === 'True';
    
    if (opened) {
        showMessage('–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞!');
        return;
    }
    
    fetch('/lab9/open/' + id)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                if (data.lock) {
                    showMessage('üîí –î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —ç—Ç–æ–π –∫–æ—Ä–æ–±–∫–∏ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É!');
                } else {
                    showMessage(data.error);
                }
            } else {
                document.getElementById('congrat').src = '/static/lab9/' + data.congrat;
                document.getElementById('result').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
                
                document.getElementById('count').textContent = data.opened;
                document.getElementById('left').textContent = 10 - data.opened;
                
                box.dataset.opened = 'True';
                box.style.cursor = 'default';
                const img = box.querySelector('img');
                img.style.opacity = '0.5';
                img.style.filter = 'grayscale(100%)';
                img.style.border = '3px solid #666';
            }
        })
        .catch(err => {
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–æ–±–∫–∏');
        });
}

function resetAll() {
    if (confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        fetch('/lab9/reset')
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error);
                } else {
                    showMessage('üéÑ –í—Å–µ –∫–æ—Ä–æ–±–∫–∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω—ã –∑–∞–Ω–æ–≤–æ!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            })
            .catch(err => {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∫–æ—Ä–æ–±–æ–∫');
            });
    }
}

function closeResult() {
    document.getElementById('result').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
}

function showMessage(text, type = 'error') {
    const div = document.getElementById('msg');
    div.textContent = text;
    div.style.display = 'block';
    
    if (type === 'success') {
        div.style.background = '#228B22';
        div.style.color = '#FFD700';
    }
    
    setTimeout(() => {
        div.style.display = 'none';
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.gift-box').forEach(box => {
        if (box.dataset.opened !== 'True') {
            box.addEventListener('mouseenter', function() {
                const img = this.querySelector('img');
                img.style.transform = 'scale(1.15)';
                img.style.boxShadow = '0 0 20px #FFD700';
                img.style.transition = 'all 0.3s';
            });
            
            box.addEventListener('mouseleave', function() {
                const img = this.querySelector('img');
                img.style.transform = 'scale(1)';
                img.style.boxShadow = 'none';
            });
        }
    });
});
</script>

<style>
.gift-box {
    transition: transform 0.3s;
}

button {
    background: linear-gradient(to bottom, #b22222, #8b0000);
    color: #FFD700;
    padding: 10px 25px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 15px;
    margin: 5px;
}

button:hover {
    background: linear-gradient(to bottom, #228B22, #0c2c1c);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
}

a {
    color: #FFD700;
    text-decoration: none;
    padding: 8px 15px;
    border-radius: 4px;
    transition: all 0.3s;
    font-size: 15px;
}

a:hover {
    background: rgba(255, 215, 0, 0.2);
    text-decoration: none;
}
</style>
{% endblock %}