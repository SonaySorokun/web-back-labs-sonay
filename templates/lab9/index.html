{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<h1>üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏</h1>

<div style="text-align: center; margin: 20px 0;">
    {% if session.user %}
        <div style="color: #FFD700; margin-bottom: 10px;">
            üëã –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{{ session.user }}</strong>
        </div>
        <button onclick="logout()" style="margin-right: 10px;">–í—ã–π—Ç–∏</button>
        <button onclick="resetAll()" style="background: #f44336;">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
    {% else %}
        <div style="display: inline-block; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
            <a href="/lab8/login" style="color: #FFD700; text-decoration: none; margin: 0 10px;">–í–æ–π—Ç–∏</a>
            |
            <a href="/lab8/register" style="color: #32CD32; text-decoration: none; margin: 0 10px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </div>
    {% endif %}
</div>

<div style="display: flex; justify-content: center; gap: 40px; margin: 30px 0;">
    <div style="text-align: center;">
        <div style="font-size: 30px; color: #FFD700;">{{ opened_count }}</div>
        <div style="color: #32CD32;">–û—Ç–∫—Ä—ã—Ç–æ</div>
    </div>
    <div style="text-align: center;">
        <div style="font-size: 30px; color: #FFD700;">{{ 10 - opened_count }}</div>
        <div style="color: #32CD32;">–û—Å—Ç–∞–ª–æ—Å—å</div>
    </div>
    <div style="text-align: center;">
        <div style="font-size: 30px; color: #FFD700;">3</div>
        <div style="color: #32CD32;">–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å</div>
    </div>
</div>

<div style="position: relative; height: 400px; margin: 30px 0; background: rgba(0,0,0,0.2); border-radius: 10px;">
    {% for box in boxes %}
    <div class="gift-box" 
         data-id="{{ box.id }}"
         data-opened="{{ box.opened }}"
         style="position: absolute; 
                left: {{ box.x }}%; 
                top: {{ box.y }}%; 
                width: 70px; 
                height: 70px; 
                cursor: {{ 'default' if box.opened else 'pointer' }};
                text-align: center;">
        
        <img src="/static/lab9/{{ box.id }}.png" 
             alt="–ü–æ–¥–∞—Ä–æ–∫ {{ box.id }}"
             style="width: 100%; 
                    height: 100%;
                    border-radius: 8px;
                    border: {{ '2px solid #666' if box.opened else '2px solid #FFD700' }};
                    {% if box.opened %}opacity: 0.4;{% endif %}">
        
        <div style="margin-top: 5px; 
                    font-size: 12px; 
                    color: {{ '#FFD700' if box.lock and not box.opened else '#32CD32' }};
                    font-weight: bold;">
            {{ box.id }}{% if box.lock and not box.opened %} üîí{% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div id="result" style="display: none; 
                        position: fixed; 
                        top: 50%; 
                        left: 50%; 
                        transform: translate(-50%, -50%); 
                        background: #0c2c1c; 
                        padding: 20px; 
                        border-radius: 10px; 
                        border: 2px solid #FFD700;
                        z-index: 1000;
                        text-align: center;">
    <div style="color: #FFD700; font-size: 20px; margin-bottom: 15px;">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ!</div>
    <img id="congrat" src="" style="max-width: 300px; max-height: 200px; border-radius: 5px;">
    <div style="margin-top: 15px;">
        <button onclick="closeResult()">–û–ö</button>
    </div>
</div>

<div id="msg" style="display: none; 
                     position: fixed; 
                     top: 20px; 
                     left: 50%; 
                     transform: translateX(-50%); 
                     padding: 10px 20px; 
                     border-radius: 5px; 
                     background: #f44336; 
                     color: white;
                     font-weight: bold;
                     z-index: 1001;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.gift-box').forEach(box => {
        box.addEventListener('click', function() {
            const id = this.dataset.id;
            const opened = this.dataset.opened === 'True';
            
            if (!opened) {
                openBox(id);
            }
        });
    });
});

function openBox(id) {
    fetch('/lab9/open/' + id)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                if (data.lock) {
                    showMessage('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —ç—Ç–æ–π –∫–æ—Ä–æ–±–∫–∏');
                } else {
                    showMessage(data.error);
                }
            } else {
                document.getElementById('congrat').src = '/static/lab9/' + data.congrat;
                document.getElementById('result').style.display = 'block';
                
                setTimeout(() => location.reload(), 1000);
            }
        });
}

function logout() {
    fetch('/lab9/logout')
        .then(r => r.json())
        .then(() => location.reload());
}

function resetAll() {
    if (confirm('–î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        fetch('/lab9/reset')
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    location.reload();
                } else {
                    showMessage(data.error);
                }
            });
    }
}

function closeResult() {
    document.getElementById('result').style.display = 'none';
}

function showMessage(text) {
    const div = document.getElementById('msg');
    div.textContent = text;
    div.style.display = 'block';
    
    setTimeout(() => div.style.display = 'none', 3000);
}
</script>

<style>
.gift-box:hover:not([data-opened="True"]) img {
    transform: scale(1.1);
    box-shadow: 0 0 10px #FFD700;
    transition: all 0.2s;
}

button {
    background: linear-gradient(to bottom, #b22222, #8b0000);
    color: #FFD700;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin: 5px;
}

button:hover {
    background: linear-gradient(to bottom, #228B22, #0c2c1c);
}

a {
    color: #FFD700;
    text-decoration: none;
    padding: 5px 10px;
}

a:hover {
    text-decoration: underline;
}
</style>
{% endblock %}