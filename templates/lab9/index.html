{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #d32f2f; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
            üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÅ
        </h1>
        <p style="color: #666; font-size: 1.2em;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ!</p>
    </div>
    
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 25px; color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                {% if user %}
                    <div style="font-size: 1.2em;">
                        üëã –ü—Ä–∏–≤–µ—Ç, <strong style="color: #FFD700;">{{ user.name }}</strong>!
                    </div>
                    <button onclick="logout()" 
                            style="margin-top: 10px; padding: 8px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 25px; cursor: pointer;">
                        –í—ã–π—Ç–∏
                    </button>
                {% else %}
                    <div style="font-size: 1.2em;">üëã –ü—Ä–∏–≤–µ—Ç! –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏</div>
                {% endif %}
            </div>
            
            {% if user %}
            <button onclick="resetBoxes()" 
                    style="padding: 12px 30px; background: #FFD700; color: #d32f2f; border: none; border-radius: 25px; font-weight: bold; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                üéÖ –í—ã–∑–≤–∞—Ç—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
            </button>
            {% endif %}
        </div>
        
        {% if not user %}
        <div style="text-align: center; margin-top: 15px;">
            <a href="/lab9/login" 
               style="display: inline-block; padding: 10px 25px; background: white; color: #667eea; text-decoration: none; border-radius: 25px; margin-right: 10px; font-weight: bold;">
                –í–æ–π—Ç–∏
            </a>
            <a href="/lab9/register" 
               style="display: inline-block; padding: 10px 25px; background: #4CAF50; color: white; text-decoration: none; border-radius: 25px; font-weight: bold;">
                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </a>
        </div>
        {% endif %}
    </div>
    
    <div style="display: flex; justify-content: space-around; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px;">
        <div style="text-align: center; padding: 15px; min-width: 150px;">
            <div style="font-size: 2.5em; font-weight: bold; color: #d32f2f;" id="opened-count">0</div>
            <div style="color: #666; font-size: 0.9em;">–û–¢–ö–†–´–¢–û –ö–û–†–û–ë–û–ö</div>
        </div>
        <div style="text-align: center; padding: 15px; min-width: 150px;">
            <div style="font-size: 2.5em; font-weight: bold; color: #388E3C;" id="remaining-count">10</div>
            <div style="color: #666; font-size: 0.9em;">–û–°–¢–ê–õ–û–°–¨ –ö–û–†–û–ë–û–ö</div>
        </div>
        <div style="text-align: center; padding: 15px; min-width: 150px;">
            <div style="font-size: 2.5em; font-weight: bold; color: #2196F3;">3</div>
            <div style="color: #666; font-size: 0.9em;">–ú–û–ñ–ù–û –û–¢–ö–†–´–¢–¨</div>
        </div>
    </div>
    
    <div style="position: relative; min-height: 500px; border: 3px dashed #ccc; border-radius: 20px; background: #f8f9fa; padding: 20px; margin-bottom: 25px;">
        <div id="boxes-container" style="position: relative; height: 500px;"></div>
    </div>
    
    <div id="congrat-popup" 
         style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; text-align: center; position: relative;">
            <button onclick="closeCongratPopup()" 
                    style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2em; color: #666; cursor: pointer;">
                √ó
            </button>
            
            <h2 style="color: #d32f2f; margin-bottom: 20px;">üéâ –í–∞—à–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ! üéâ</h2>
            
            <div id="congrat-image-container" style="margin: 20px 0;">
                <img id="congrat-image" src="" alt="–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ" 
                     style="max-width: 100%; max-height: 400px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
            </div>
            
            <div id="gift-title" style="font-size: 1.3em; color: #2E7D32; font-weight: bold; margin: 15px 0;"></div>
            
            <button onclick="closeCongratPopup()" 
                    style="padding: 12px 40px; background: #4CAF50; color: white; border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer; margin-top: 20px;">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    
    <div id="message" style="display: none; padding: 15px; border-radius: 10px; margin: 10px 0;"></div>
    
    <div style="background: #E3F2FD; padding: 25px; border-radius: 15px; border-left: 5px solid #2196F3;">
        <h3 style="color: #1565C0; margin-top: 0;">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div style="padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px;">
                <div style="font-weight: bold; color: #d32f2f;">1. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫</div>
                <div>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ–¥–∞—Ä–∫–∞</div>
            </div>
            <div style="padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px;">
                <div style="font-weight: bold; color: #d32f2f;">2. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                <div>–£–≤–∏–¥–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–º –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ–º</div>
            </div>
            <div style="padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px;">
                <div style="font-weight: bold; color: #d32f2f;">3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 3 –ø–æ–¥–∞—Ä–∫–∞</div>
                <div>–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ç–æ–ª—å–∫–æ 3 –∫–æ—Ä–æ–±–∫–∏</div>
            </div>
            <div style="padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px;">
                <div style="font-weight: bold; color: #d32f2f;">4. –û—Å–æ–±—ã–µ –ø–æ–¥–∞—Ä–∫–∏ üîí</div>
                <div>–ü–æ–¥–∞—Ä–∫–∏ —Å –∑–∞–º–∫–æ–º –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞</div>
            </div>
        </div>
    </div>
</div>

<script>
function loadBoxes() {
    fetch('/lab9/api/boxes')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('boxes-container');
            container.innerHTML = '';
            
            document.getElementById('opened-count').textContent = data.opened_count;
            document.getElementById('remaining-count').textContent = 10 - data.opened_count;
            
            data.boxes.forEach(box => {
                const boxDiv = document.createElement('div');
                boxDiv.className = 'gift-box';
                boxDiv.style.position = 'absolute';
                boxDiv.style.left = box.x + '%';
                boxDiv.style.top = box.y + '%';
                boxDiv.style.cursor = box.opened ? 'default' : 'pointer';
                boxDiv.dataset.id = box.id;
                boxDiv.dataset.opened = box.opened;
                
                const img = document.createElement('img');
                if (box.opened) {
                    img.src = data.static_url + 'lab9/images/opened_box.png';
                    img.alt = '–û—Ç–∫—Ä—ã—Ç–∞—è –∫–æ—Ä–æ–±–∫–∞ ' + box.id;
                    img.style.filter = 'grayscale(0.7)';
                    img.style.opacity = '0.6';
                } else {
                    img.src = data.static_url + 'lab9/images/' + box.gift_image;
                    img.alt = box.title;
                }
                
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.borderRadius = '10px';
                img.style.boxShadow = box.opened ? '0 2px 5px rgba(0,0,0,0.1)' : '0 5px 15px rgba(0,0,0,0.3)';
                img.style.transition = 'all 0.3s';
                img.style.border = box.opened ? '3px solid #aaa' : '3px solid #FFD700';
                
                if (!box.opened) {
                    img.onmouseover = function() {
                        this.style.transform = 'scale(1.15) rotate(5deg)';
                        this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.4)';
                    };
                    img.onmouseout = function() {
                        this.style.transform = 'scale(1) rotate(0deg)';
                        this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                    };
                    
                    boxDiv.onclick = function() {
                        openBox(box.id);
                    };
                }
                
                const badge = document.createElement('div');
                badge.textContent = box.id;
                badge.style.position = 'absolute';
                badge.style.top = '-25px';
                badge.style.left = '50%';
                badge.style.transform = 'translateX(-50%)';
                badge.style.background = box.opened ? '#aaa' : (box.requires_auth ? '#FF9800' : '#d32f2f');
                badge.style.color = 'white';
                badge.style.padding = '2px 10px';
                badge.style.borderRadius = '10px';
                badge.style.fontSize = '12px';
                badge.style.fontWeight = 'bold';
                badge.style.minWidth = '30px';
                badge.style.textAlign = 'center';
                
                if (box.requires_auth && !box.opened) {
                    badge.innerHTML = box.id + ' üîí';
                    badge.style.background = '#FF9800';
                }
                
                boxDiv.appendChild(img);
                boxDiv.appendChild(badge);
                container.appendChild(boxDiv);
            });
        })
        .catch(err => showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤', 'error'));
}

function openBox(id) {
    fetch(`/lab9/api/open/${id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            if (data.requires_auth) {
                showMessage('üîí –î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —ç—Ç–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'warning');
            } else {
                showMessage(data.error, 'error');
            }
        } else {
            const congratImg = document.getElementById('congrat-image');
            const giftTitle = document.getElementById('gift-title');
            
            congratImg.src = data.static_url + 'lab9/images/' + data.congrat_image;
            giftTitle.textContent = data.title;
            
            document.getElementById('congrat-popup').style.display = 'flex';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadBoxes();
        }
    })
    .catch(err => showMessage('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–¥–∞—Ä–∫–∞', 'error'));
}

function closeCongratPopup() {
    document.getElementById('congrat-popup').style.display = 'none';
}

function resetBoxes() {
    if (!confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ! –í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
        return;
    }
    
    fetch('/lab9/api/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            showMessage(data.error, 'error');
        } else {
            showMessage(data.message, 'success');
            loadBoxes();
            closeCongratPopup();
        }
    })
    .catch(err => showMessage('–û—à–∏–±–∫–∞', 'error'));
}

function logout() {
    fetch('/lab9/logout')
        .then(r => r.json())
        .then(() => {
            location.reload();
        })
        .catch(err => showMessage('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞', 'error'));
}

function showMessage(text, type) {
    const div = document.getElementById('message');
    div.textContent = text;
    div.style.display = 'block';
    div.style.background = type === 'error' ? '#FFEBEE' : 
                          type === 'warning' ? '#FFF3E0' : '#E8F5E9';
    div.style.color = type === 'error' ? '#C62828' : 
                     type === 'warning' ? '#E65100' : '#2E7D32';
    div.style.border = type === 'error' ? '2px solid #F44336' :
                      type === 'warning' ? '2px solid #FF9800' : '2px solid #4CAF50';
    
    setTimeout(() => {
        div.style.display = 'none';
    }, 4000);
}

loadBoxes();
</script>
{% endblock %}