{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<link rel="stylesheet" href="{{ url_for('static', filename='ng.css') }}">

<h1>üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÑ</h1>

<div style="text-align: center; margin: 20px 0;">
    {% if session.user %}
        <div style="font-size: 18px; color: #FFD700;">
            üëã –ü—Ä–∏–≤–µ—Ç, {{ session.user }}!
            <button onclick="logout()" style="margin-left: 20px;">–í—ã–π—Ç–∏</button>
            <button onclick="resetAll()" style="background: #f44336;">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
        </div>
    {% else %}
        <form id="login" style="display: inline;">
            <input type="text" name="login" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" required>
            <button type="submit">–í–æ–π—Ç–∏</button>
        </form>
        <div style="color: #FFD700; margin-top: 5px;">–õ—é–±–æ–π –ª–æ–≥–∏–Ω –ø–æ–¥–æ–π–¥–µ—Ç</div>
    {% endif %}
</div>

<div style="display: flex; justify-content: center; gap: 50px; margin: 30px 0;">
    <div style="text-align: center;">
        <div style="font-size: 36px; color: #FFD700;">{{ opened_count }}</div>
        <div style="color: #32CD32;">–û—Ç–∫—Ä—ã—Ç–æ</div>
    </div>
    <div style="text-align: center;">
        <div style="font-size: 36px; color: #FFD700;">{{ 10 - opened_count }}</div>
        <div style="color: #32CD32;">–û—Å—Ç–∞–ª–æ—Å—å</div>
    </div>
    <div style="text-align: center;">
        <div style="font-size: 36px; color: #FFD700;">3</div>
        <div style="color: #32CD32;">–õ–∏–º–∏—Ç</div>
    </div>
</div>

<div style="position: relative; height: 400px; margin: 40px 0;">
    {% for box in boxes %}
    <div onclick="openBox({{ box.id }})" 
         style="position: absolute; 
                left: {{ box.x }}%; 
                top: {{ box.y }}%; 
                width: 80px; 
                height: 80px; 
                cursor: pointer;"
         class="gift-box">
        
        <img src="/static/lab9/{{ box.id }}.png" 
             alt="–ü–æ–¥–∞—Ä–æ–∫ {{ box.id }}"
             style="width: 100%; 
                    height: 100%; 
                    border: {{ '3px solid #888' if box.opened else '3px solid #FFD700' }};
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    {% if box.opened %}filter: grayscale(100%) brightness(0.6);{% endif %}">
        
        <div style="position: absolute; 
                    top: -25px; 
                    left: 0; 
                    width: 100%; 
                    text-align: center;
                    color: {{ '#FFD700' if box.lock and not box.opened else 'white' }};
                    font-weight: bold;">
            {{ box.id }}{% if box.lock and not box.opened %} üîí{% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div id="result" style="display: none; 
                        position: fixed; 
                        top: 50%; 
                        left: 50%; 
                        transform: translate(-50%, -50%); 
                        background: rgba(12, 44, 28, 0.95); 
                        padding: 30px; 
                        border-radius: 15px; 
                        border: 3px solid #FFD700;
                        z-index: 1000;
                        text-align: center;">
    <h2 style="color: #FFD700; margin-top: 0;">üéâ –í–∞—à–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ!</h2>
    <img id="congrat" src="" style="max-width: 400px; max-height: 300px; border-radius: 10px;">
    <div style="margin-top: 20px;">
        <button onclick="closeResult()" style="padding: 10px 30px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="msg" style="display: none; 
                     position: fixed; 
                     top: 20px; 
                     left: 50%; 
                     transform: translateX(-50%); 
                     padding: 15px 30px; 
                     border-radius: 10px; 
                     color: white;
                     font-weight: bold;
                     z-index: 1001;"></div>

<script>
function openBox(id) {
    fetch('/lab9/open/' + id)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                if (data.lock) {
                    showMessage('üîí –ù—É–∂–Ω–æ –≤–æ–π—Ç–∏!', '#FF9800');
                } else {
                    showMessage(data.error, '#f44336');
                }
            } else {
                document.getElementById('congrat').src = '/static/lab9/' + data.congrat;
                document.getElementById('result').style.display = 'block';
                
                setTimeout(() => location.reload(), 500);
            }
        });
}

document.getElementById('login')?.onsubmit = function(e) {
    e.preventDefault();
    const form = new FormData(this);
    
    fetch('/lab9/login', {
        method: 'POST',
        body: form
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            location.reload();
        } else {
            showMessage(data.error, '#f44336');
        }
    });
};

function logout() {
    fetch('/lab9/logout')
        .then(r => r.json())
        .then(() => location.reload());
}

function resetAll() {
    if (confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏?')) {
        fetch('/lab9/reset')
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    location.reload();
                } else {
                    showMessage(data.error, '#f44336');
                }
            });
    }
}

function closeResult() {
    document.getElementById('result').style.display = 'none';
}

function showMessage(text, color) {
    const div = document.getElementById('msg');
    div.textContent = text;
    div.style.background = color;
    div.style.display = 'block';
    
    setTimeout(() => div.style.display = 'none', 3000);
}

document.querySelectorAll('.gift-box').forEach(box => {
    box.onmouseover = function() {
        const img = this.querySelector('img');
        if (!img.style.filter.includes('grayscale')) {
            img.style.transform = 'scale(1.1)';
            img.style.boxShadow = '0 8px 25px rgba(255, 215, 0, 0.5)';
        }
    };
    
    box.onmouseout = function() {
        const img = this.querySelector('img');
        img.style.transform = 'scale(1)';
        img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
    };
});
</script>
{% endblock %}