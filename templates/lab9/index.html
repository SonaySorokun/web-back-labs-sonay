{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <h1 style="text-align: center; color: #d32f2f;">üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÑ</h1>
    
    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin: 20px 0;">
        {% if user %}
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    –ü—Ä–∏–≤–µ—Ç, <strong>{{ user.name }}</strong>!
                    <button onclick="logout()" style="margin-left: 20px; padding: 5px 15px; background: #ff4444; color: white; border: none; border-radius: 5px;">
                        –í—ã–π—Ç–∏
                    </button>
                </div>
                <button onclick="resetBoxes()" style="padding: 8px 20px; background: #d32f2f; color: white; border: none; border-radius: 5px;">
                    üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑
                </button>
            </div>
        {% else %}
            <div style="text-align: center;">
                <a href="/lab9/login" style="padding: 8px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px; margin-right: 10px;">
                    –í–æ–π—Ç–∏
                </a>
                <a href="/lab9/register" style="padding: 8px 20px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px;">
                    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </a>
            </div>
        {% endif %}
    </div>
    
    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin: 20px 0; display: flex; justify-content: space-around;">
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #d32f2f;" id="opened-count">0</div>
            <div>–û—Ç–∫—Ä—ã—Ç–æ –∫–æ—Ä–æ–±–æ–∫</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #388E3C;" id="remaining-count">10</div>
            <div>–û—Å—Ç–∞–ª–æ—Å—å –∫–æ—Ä–æ–±–æ–∫</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #1976D2;">3</div>
            <div>–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å</div>
        </div>
    </div>
    
    <div style="position: relative; height: 600px; border: 3px solid #ccc; border-radius: 15px; background: #f9f9f9; margin: 20px 0; overflow: hidden;">
        <div id="boxes-container"></div>
    </div>
    
    <div id="result" style="display: none; padding: 20px; background: #fff3e0; border-radius: 10px; margin: 20px 0; border-left: 5px solid #FF9800;">
        <h3 style="margin-top: 0; color: #FF5722;">üéâ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–¥–∞—Ä–æ–∫!</h3>
        <div style="font-size: 24px; text-align: center; margin: 20px 0;" id="gift-display"></div>
        <div style="font-size: 18px; text-align: center; font-style: italic;" id="message-text"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="document.getElementById('result').style.display = 'none'" style="padding: 10px 30px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    
    <div id="message" style="display: none; padding: 15px; border-radius: 5px; margin: 10px 0;"></div>
    
    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px;">
        <h4 style="margin-top: 0;">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</h4>
        <p>1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ—Ä–æ–±–∫—É üéÅ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</p>
        <p>2. –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å <strong>—Ç–æ–ª—å–∫–æ 3 –∫–æ—Ä–æ–±–∫–∏</strong></p>
        <p>3. –ö–æ—Ä–æ–±–∫–∏ —Å üîí –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º</p>
        <p>4. –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å üéÖ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞</p>
    </div>
</div>

<script>
function loadBoxes() {
    fetch('/lab9/api/boxes')
        .then(r => r.json())
        .then(boxes => {
            const container = document.getElementById('boxes-container');
            container.innerHTML = '';
            
            let openedCount = 0;
            
            boxes.forEach(box => {
                const div = document.createElement('div');
                div.className = 'box';
                div.style.position = 'absolute';
                div.style.left = box.x + '%';
                div.style.top = box.y + '%';
                div.style.width = '80px';
                div.style.height = '80px';
                div.style.background = box.opened ? '#bbb' : '#f44336';
                div.style.border = '3px solid ' + (box.opened ? '#888' : '#b71c1c');
                div.style.borderRadius = '10px';
                div.style.cursor = box.opened ? 'default' : 'pointer';
                div.style.textAlign = 'center';
                div.style.lineHeight = '80px';
                div.style.fontSize = '36px';
                div.style.transition = 'all 0.3s';
                div.dataset.id = box.id;
                
                if (box.opened) {
                    div.textContent = '‚úì';
                    div.style.color = '#666';
                    openedCount++;
                } else {
                    div.textContent = 'üéÅ';
                }
                
                if (box.requires_auth && !box.opened) {
                    div.style.background = '#ff9800';
                    div.style.borderColor = '#f57c00';
                    div.title = '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
                }
                
                if (!box.opened) {
                    div.onclick = () => openBox(box.id);
                    div.onmouseover = () => {
                        if (!box.opened) {
                            div.style.transform = 'scale(1.1)';
                        }
                    };
                    div.onmouseout = () => {
                        div.style.transform = 'scale(1)';
                    };
                }
                
                const num = document.createElement('div');
                num.textContent = box.id;
                num.style.position = 'absolute';
                num.style.top = '-25px';
                num.style.left = '0';
                num.style.width = '100%';
                num.style.textAlign = 'center';
                num.style.fontSize = '14px';
                num.style.fontWeight = 'bold';
                
                if (box.requires_auth && !box.opened) {
                    num.innerHTML = box.id + ' üîí';
                    num.style.color = '#e65100';
                }
                
                div.appendChild(num);
                container.appendChild(div);
            });
            
            document.getElementById('opened-count').textContent = openedCount;
            document.getElementById('remaining-count').textContent = 10 - openedCount;
        })
        .catch(err => showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error'));
}

function openBox(id) {
    fetch(`/lab9/api/open/${id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            if (data.requires_auth) {
                showMessage('–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —ç—Ç–æ–π –∫–æ—Ä–æ–±–∫–∏', 'warning');
            } else {
                showMessage(data.error, 'error');
            }
        } else {
            document.getElementById('gift-display').textContent = data.gift;
            document.getElementById('message-text').textContent = data.message;
            document.getElementById('result').style.display = 'block';
            
            loadBoxes();
        }
    })
    .catch(err => showMessage('–û—à–∏–±–∫–∞', 'error'));
}

function resetBoxes() {
    if (!confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏? –¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö!')) {
        return;
    }
    
    fetch('/lab9/api/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            showMessage(data.error, 'error');
        } else {
            showMessage(data.message, 'success');
            loadBoxes();
            document.getElementById('result').style.display = 'none';
        }
    })
    .catch(err => showMessage('–û—à–∏–±–∫–∞', 'error'));
}

function logout() {
    fetch('/lab9/logout')
        .then(r => r.json())
        .then(() => {
            location.reload();
        });
}

function showMessage(text, type) {
    const div = document.getElementById('message');
    div.textContent = text;
    div.style.display = 'block';
    div.style.background = type === 'error' ? '#ffebee' : 
                          type === 'warning' ? '#fff3e0' : '#e8f5e9';
    div.style.color = type === 'error' ? '#c62828' : 
                     type === 'warning' ? '#e65100' : '#2e7d32';
    div.style.borderLeft = type === 'error' ? '5px solid #f44336' :
                          type === 'warning' ? '5px solid #ff9800' : '5px solid #4CAF50';
    
    setTimeout(() => {
        div.style.display = 'none';
    }, 3000);
}

loadBoxes();
</script>
{% endblock %}